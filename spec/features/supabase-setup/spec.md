<!-- SAVE_AS: spec/features/supabase-setup/spec.md -->

# Supabase Setup Foundation

**Статус:** draft
**Цель:** Нужно создать структуру файлов и папок для старта работы с supabase, подготовить стартовые файлы edge-функций и наладить автодеплой edge-функций в Supabase при мерже в ветку main.

## User Stories
- Как разработчик, я хочу получить базовую структуру каталогов и конфигурационных файлов Supabase в проекте, чтобы сразу подключаться к локальному окружению и писать edge-функции без ручной подготовки.
- Как разработчик edge-функций, я хочу иметь шаблонные файлы для типовых функций (ping, webhook и т.п.), чтобы понимать рекомендуемую архитектуру и быстро создавать новые функции.
- Как инженер по инфраструктуре, я хочу автоматизированный пайплайн деплоя edge-функций в Supabase при мерже в main, чтобы исключить ручные действия и избежать рассинхронизации окружений.
- Как тимлид, я хочу прозрачную документацию по запуску и деплою Supabase и edge-функций, чтобы новые разработчики могли подключаться к проекту без длительного онбординга.

## Основные сценарии и правила
- Структура репозитория содержит корневой каталог `supabase/` с подпапками `functions/`, `config/` и артефактами CLI (`.env.example`, `supabase/config.toml`, документация по запуску).
- Для edge-функций создаются шаблонные каталоги `supabase/functions/<function-name>/` с файлами `index.ts` (TypeScript), `deno.json` (если требуется), `README.md` с описанием назначения функции и входных/выходных данных.
- Добавляется базовая функция-заглушка (например, `hello-world`) с типовым ответом и интеграционными тестами/инструкциями по локальному запуску через `supabase functions serve`.
- Документация описывает процесс локального запуска Supabase, миграций, тестирования edge-функций и деплоя (включая необходимые CLI-команды и настройки переменных окружения).
- Настраивается CI/CD (предпочтительно GitHub Actions) с шагами: установка Supabase CLI, авторизация через `SUPABASE_ACCESS_TOKEN`, деплой всех функций командой `supabase functions deploy --project-ref <PROJECT_REF>` только для ветки `main` и уведомление об ошибках.
- Пайплайн должен использовать секреты репозитория для токена и идентификатора проекта, а также кэшировать зависимые артефакты (например, `deno` модуль кэш) для ускорения повторных запусков.
- В README или отдельном файле фиксируются правила именования функций, зависимостей (Deno std, разрешённые внешние URL) и требования по структурированию кода/логирования.
- Добавляются проверки перед деплоем: линтер/форматтер Deno, unit-тесты для edge-функций, а также проверка наличия обязательных секретов.
- Обеспечивается возможность локально запускать пайплайн (скрипт или make-таргет), чтобы разработчики могли валидировать изменения до PR.

## Нефункциональные требования
- Пайплайн деплоя должен выполняться менее чем за 10 минут при обновлении до 5 функций, включая установку зависимостей и прогон тестов.
- Все секреты и токены хранятся только в менеджере секретов (GitHub Secrets) с ограничениями доступа; в репозитории используются `.env.example` без реальных ключей.
- Стартовые edge-функции должны проходить форматирование и линтинг Deno без ошибок; стандартный lint формат задаётся в `deno.json`.
- Документация и комментарии пишутся на одном языке (английском или русском) и поддерживают корпоративные стандарты; все файлы в UTF-8.
- Структура должна быть совместима с Supabase CLI LTS версиями и не требовать дополнительных платных сервисов.
- Логи edge-функций и пайплайна должны быть доступны для диагностики, содержать минимум PII и очищаться от чувствительных данных.

## Assumptions
- Supabase проект уже создан, доступны `SUPABASE_ACCESS_TOKEN` и `PROJECT_REF`, и их можно добавить в секреты CI.
- Команда использует GitHub и GitHub Actions; альтернативные CI-платформы пока не рассматриваются.
- Edge-функции пишутся на TypeScript/Deno; другие рантаймы (Go, Python) не планируются на первом этапе.
- Команда готова установить Supabase CLI локально (через npm или standalone) и имеет права на деплой в проект.
- Предполагается, что количество edge-функций в ближайшее время не превышает 10, поэтому масштабирование структуры и пайплайна под очень большое число функций пока не анализируется.
- Необходимость интеграции с внешними сервисами (Webhook endpoints, OAuth) будет уточняться по мере появления конкретных задач.
